#!/usr/bin/env bash

if [ ! -f gotty ]; then
    wget https://github.com/yudai/gotty/releases/download/v1.0.1/gotty_linux_amd64.tar.gz
    tar -xf gotty_linux_amd64.tar.gz
fi

LOG_FILE="daemon.log"
PID_FILE="daemon.pid"
EMACS_SERVER="emacsd"

case "$1" in
    start)
        if [ -f "$PID_FILE" ]; then
            echo "Already Running"
            exit
        fi

        echo "Starting Emacs Daemon"
        emacs -nw --daemon=$EMACS_SERVER -l ../../init.el > $LOG_FILE 2>&1
        ./gotty --config gotty.config -w emacsclient --tty -s emacsd > $LOG_FILE 2>&1 &
        echo $! > $PID_FILE
        ;;
    stop)
        if [ ! -f "$PID_FILE" ]; then
            echo "Not Running"
            exit
        fi

        echo "Shutting Emacs Daemon"
        emacsclient -s $EMACS_SERVER --eval '(let (kill-emacs-hook) (kill-emacs))'
        kill -9 `cat $PID_FILE`
        rm $PID_FILE
        ;;
    restart)
        $0 stop
        $0 start
        ;;
    status)
        if [ -f "$PID_FILE" ]; then
            echo "Running"
        else 
            echo "Stopped"
        fi
        ;;
    *)
        ## If no parameters are given, print which are avaiable.
        echo "Usage: $0 {start|stop|status|restart}"
        exit 1
        ;;
esac
