# ansible-playbook deploy.yml -i '127.0.0.1,' -u nakkaya -K
---
-
 
 hosts: all
 become: yes

 vars:
   systemd_enb: true
   xpra_enb: false

   emacsd_user: nakkaya
   wetty_port: 1337
   wetty_title: "emacs @ local"
   wetty_base: "/emacs/local"
   nodejs_version: "14"
   
 tasks:

   - name: Add repositories
     apt_repository: repo='ppa:kelleyk/emacs' state=present

   - name: install the gpg key for nodejs LTS
     apt_key:
       url: "https://deb.nodesource.com/gpgkey/nodesource.gpg.key"
       state: present

   - name: install the nodejs LTS repos
     apt_repository:
       repo: "deb https://deb.nodesource.com/node_{{ nodejs_version }}.x {{ ansible_distribution_release }} main"
       state: present
       update_cache: yes

   - name: install the gpg key for xpra
     apt_key:
       url: "https://xpra.org/gpg.asc"
       state: present

   - name: install the xpra repos
     apt_repository:
       repo: "deb https://xpra.org/ {{ ansible_distribution_release }} main"
       state: present
       update_cache: yes

   - name: system upgrade
     apt:
       upgrade: yes
       update_cache: yes
       cache_valid_time: 86400 #One day

   - name: install requirements
     apt:
       pkg:
         - sshpass
         - nodejs
         - emacs27
         - xpra
       state: present

   - name: install yarn
     shell: yarn --version || npm install --global yarn

   - name: install wetty
     shell: yarn global add wetty

   - name: clone emacsd
     git:
       repo: 'https://github.com/nakkaya/emacs.git'
       dest: /var/emacsd
       clone: yes
       update: yes
       
   - name: set emacsd owner
     file:
       path: /var/emacsd
       state: directory
       recurse: yes
       owner: "{{ emacsd_user }}"
       group: "{{ emacsd_user }}"

   - name: wetty conf
     template:
       src: wetty.conf
       dest: /var/emacsd/wetty.conf

   - name: bin
     template:
       src: emacsd
       dest: /usr/bin/emacsd
       mode: 0777

   - name: assure .desktop folder exists
     file: path=/home/{{ emacsd_user }}/.local/share/applications/ state=directory

   - name: gnome desktop
     template:
       src: emacsd.desktop
       dest: /home/{{ emacsd_user }}/.local/share/applications/emacsd.desktop

   - name: create systemd folder
     file:
       path: /etc/systemd/system/
       state: directory
     when: systemd_enb

   - name: emacs_daemon.service
     template:
       src: emacs_daemon.service
       dest: /etc/systemd/system/emacs_daemon.service
     when: systemd_enb

   - name: emacs_webapp.service
     template:
       src: emacs_webapp.service
       dest: /etc/systemd/system/emacs_webapp.service
     when: systemd_enb

   - name: emacs_xpra.service
     template:
       src: emacs_xpra.service
       dest: /etc/systemd/system/emacs_xpra.service
     when: systemd_enb and xpra_enb

   - name: run emacs_daemon
     systemd:
       name: emacs_daemon
       enabled: yes
       state: restarted
       daemon_reload: yes
     when: systemd_enb

   - name: run emacs_webapp
     systemd:
       name: emacs_webapp
       enabled: yes
       state: restarted
       daemon_reload: yes
     when: systemd_enb

   - name: run emacs_xpra
     systemd:
       name: emacs_xpra
       enabled: yes
       state: restarted
       daemon_reload: yes
     when: systemd_enb and xpra_enb
