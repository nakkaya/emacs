# ansible-playbook deploy.yml -i '127.0.0.1,' -u nakkaya -K
---
-
 
 hosts: all
 become: yes

 vars:

   emacsd_user: nakkaya
   wetty_port: 1337
   wetty_title: "emacs @ 2080"
   wetty_base: "/emacs/2080"
   nodejs_version: "14"
   
 tasks:

   - name: install the gpg key for nodejs LTS
     apt_key:
       url: "https://deb.nodesource.com/gpgkey/nodesource.gpg.key"
       state: present

   - name: install the nodejs LTS repos
     apt_repository:
       repo: "deb https://deb.nodesource.com/node_{{ nodejs_version }}.x {{ ansible_distribution_release }} main"
       state: present
       update_cache: yes
   
   - name: system upgrade
     apt:
       upgrade: yes
       update_cache: yes
       cache_valid_time: 86400 #One day

   - name: install requirements
     action: apt name={{ item }} state=present
     with_items:
      - sshpass
      - nodejs

   - name: clone emacsd
     git:
       repo: 'https://github.com/nakkaya/emacs.git'
       dest: /var/emacsd
       clone: yes
       update: yes
       
   - name: set emacsd owner
     file:
       path: /var/emacsd
       state: directory
       recurse: yes
       owner: "{{ emacsd_user }}"
       group: "{{ emacsd_user }}"

   - name: create systemd folder
     file:
       path: /etc/systemd/system/
       state: directory

   - name: emacs_daemon.service
     template:
       src: emacs_daemon.service
       dest: /etc/systemd/system/emacs_daemon.service

   - name: emacs_webapp.service
     template:
       src: emacs_webapp.service
       dest: /etc/systemd/system/emacs_webapp.service

   - name: wetty conf
     template:
       src: wetty.conf
       dest: /var/emacsd/wetty.conf

   - name: run emacs_daemon
     systemd:
       name: emacs_daemon
       enabled: yes
       state: restarted
       daemon_reload: yes

   - name: run emacs_webapp
     systemd:
       name: emacs_webapp
       enabled: yes
       state: restarted
       daemon_reload: yes

   - name: bin
     template:
       src: emacsd
       dest: /usr/bin/emacsd
       mode: 0777

   - name: gnome desktop
     template:
       src: emacsd.desktop
       dest: /home/{{ emacsd_user }}/.local/share/applications/emacsd.desktop
